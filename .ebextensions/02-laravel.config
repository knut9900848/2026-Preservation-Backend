commands:
  01_install_node:
    command: "dnf install -y nodejs npm"
  02_install_chrome_deps:
    command: "dnf install -y alsa-lib atk cups-libs gtk3 libXcomposite libXcursor libXdamage libXext libXi libXrandr pango at-spi2-atk libXt dbus-glib libdrm libgbm libxshmfence nss"
  03_install_chrome:
    command: |
      if ! command -v google-chrome-stable &> /dev/null; then
        curl -o /tmp/google-chrome.rpm https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
        dnf install -y /tmp/google-chrome.rpm
        rm -f /tmp/google-chrome.rpm
      fi

container_commands:
  01_clear_local_cache:
    command: "rm -f /var/app/staging/bootstrap/cache/*.php"
  02_env_file:
    command: "/opt/elasticbeanstalk/bin/get-config --output YAML environment | sed 's/: /=/' > /var/app/staging/.env"
  03_clear_cache:
    command: "php /var/app/staging/artisan optimize:clear"
  04_permissions:
    command: "chmod -R 775 /var/app/staging/storage /var/app/staging/bootstrap/cache && chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache"
  05_migrate:
    command: "php /var/app/staging/artisan migrate --force"
    leader_only: true
  06_seed:
    command: "php /var/app/staging/artisan db:seed --force 2>/dev/null || true"
    leader_only: true
  07_config_cache:
    command: "php /var/app/staging/artisan config:cache"
  08_route_cache:
    command: "php /var/app/staging/artisan route:cache"
  09_view_cache:
    command: "php /var/app/staging/artisan view:cache"
  10_npm_install_puppeteer:
    command: "cd /var/app/staging && PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm install puppeteer --no-save --unsafe-perm"
  11_storage_link:
    command: "php /var/app/staging/artisan storage:link"
